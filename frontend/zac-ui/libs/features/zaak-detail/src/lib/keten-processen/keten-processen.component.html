<div class="keten-processen card">
  <!-- Loading -->
  <ng-container *ngIf="isLoading">
    <gu-loading-indicator></gu-loading-indicator>
  </ng-container>

  <!-- Loaded -->
  <ng-container *ngIf="!!data && data?.length > 0">

    <!-- Action buttons -->
    <div class="keten-processen__actie-buttons-container">
      <h3>Acties</h3>
      <button gu-button
              *ngFor="let message of data[0].messages"
              (click)="sendMessage(message)"
              type="primary"
              size="small"
              class="d-inline-block mr-2 mb-2">
        {{message}}
      </button>
    </div>

    <!-- Feedback/error messages -->
    <div *ngIf="sendMessageHasError" class="mb-4">
      <gu-message type="warn" message="{{sendMessageErrorMessage}}"></gu-message>
    </div>

    <!-- Task lists -->
    <div class="keten-processen__taken">
      <div class="row">

        <!-- Tasks -->
        <div class="col-md-6 mb-4 mb-md-0">
          <h3 *ngIf="data[0]?.tasks.length > 0">Vaste taken</h3>
          <div class="taak d-flex justify-content-between" *ngFor="let task of data[0].tasks">

            <!-- Description -->
            <div class="taak__detail mr-md-2">
              <label class="label label--date">{{task.created | date:'fullDate'}}</label>
              <p class="p--marginsmall p--bold">{{task.name}}</p>

                <gu-chip *ngIf="ketenProcessenService.isTaskAssigned(task)"
                         [color]="ketenProcessenService.isTaskAssignedToUser(currentUser, task) ? 'primary' : 'tertiary'"
                         [icon]="ketenProcessenService.isUserAllowedToAssignTask(currentUser, task) ? 'edit' : null"
                         (click)="ketenProcessenService.isUserAllowedToAssignTask(currentUser, task) && executeTask(task.id, 1)"
                         class="d-inline-block mb-2"
                         [class.chip--clickable]="ketenProcessenService.isUserAllowedToAssignTask(currentUser, task)"
                >

                <ng-container *ngIf="task.assignee.firstName && task.assignee.lastName; else username" >
                  {{task.assignee.firstName}} {{task.assignee.lastName}}
                </ng-container>

                <ng-template #username>
                  {{task.assignee.username}}
                </ng-template>
              </gu-chip>
            </div>

            <!-- Actions -->
            <div class="d-flex flex-column justify-content-center">
              <ng-container *ngIf="ketenProcessenService.isTaskActionableByUser(currentUser, task)">
                <button gu-button class="mb-2" type="secondary" size="small" (click)="executeTask(task.id)">
                  Behandelen
                </button>
              </ng-container>
            </div>

          </div>
        </div>

        <!-- Sub processes -->
        <div class="col-md-6">
          <h3 *ngIf="data[0]?.subProcesses.length > 0">Deeltaken</h3>
          <ng-container *ngFor="let subProcess of data[0].subProcesses">
            <div class="taak d-flex justify-content-between" *ngFor="let task of subProcess.tasks">

              <!-- Description -->
              <div class="taak__detail mr-md-2">
                <label class="label label--date">{{task.created | date:'fullDate'}}</label>
                <p class="p--marginsmall p--bold" *ngIf="task.name">{{task.name}}</p>

                <gu-chip *ngIf="ketenProcessenService.isTaskAssigned(task)"
                         [color]="ketenProcessenService.isTaskAssignedToUser(currentUser, task) ? 'primary' : 'tertiary'"
                         [icon]="ketenProcessenService.isUserAllowedToAssignTask(currentUser, task) ? 'edit' : null"
                         (click)="ketenProcessenService.isUserAllowedToAssignTask(currentUser, task) && executeTask(task.id, 1)"
                         class="d-inline-block mb-2"
                         [class.chip--clickable]="ketenProcessenService.isUserAllowedToAssignTask(currentUser, task)"
                >

                  <ng-container *ngIf="task.assignee.firstName && task.assignee.lastName; else username" >
                    {{task.assignee.firstName}} {{task.assignee.lastName}}
                  </ng-container>
                  <ng-template #username>
                    {{task.assignee.username}}
                  </ng-template>
                </gu-chip>
              </div>

                <!-- Actions -->
                <div class="d-flex flex-column justify-content-center">
                  <ng-container *ngIf="ketenProcessenService.isTaskActionableByUser(currentUser, task)">
                    <button gu-button class="mb-2" type="secondary" size="small" (click)="executeTask(task.id)">
                      Behandelen
                    </button>
                  </ng-container>
                </div>

            </div>
          </ng-container>
        </div>

      </div>
    </div>
  </ng-container>

  <!-- Empty message -->
  <ng-container *ngIf="!!data && data.length === 0 && !isLoading">
    <p>Er zijn geen acties beschikbaar.</p>
  </ng-container>
</div>


<!-- Modal -->
<gu-modal id="ketenprocessenModal" [closeIcon]="true">

  <!-- Loading -->
  <ng-container *ngIf="isLoadingContext">
    <gu-loading-indicator></gu-loading-indicator>
  </ng-container>

  <!-- Feedback/error messages -->
  <ng-container *ngIf="contextHasError">
    <gu-message type="warn" [message]="contextErrorMessage"></gu-message>
  </ng-container>

  <!-- Loaded -->
  <ng-container *ngIf="!isLoadingContext && taskContextData" [ngSwitch]="taskContextData.form">
    <mat-tab-group mat-align-tabs="center">

      <!-- Execute task -->
      <mat-tab label="Uitvoeren" *ngIf="ketenProcessenService.isUserAllowedToExecuteTask(currentUser, taskContextData.task)">
        <div class="pt-4">
          <gu-config-adviseren-accorderen *ngSwitchCase="['zac:configureAdviceRequest', 'zac:configureApprovalRequest'].includes(taskContextData.form) ? taskContextData.form : !taskContextData.form"
                                          [taskContextData]="taskContextData"
                                          (successReload)="fetchProcesses()"
          ></gu-config-adviseren-accorderen>

          <gu-document-select *ngSwitchCase="'zac:documentSelectie'" [taskContextData]="taskContextData" (successReload)="closeModal()"></gu-document-select>

          <gu-sign-document *ngSwitchCase="'zac:validSign:configurePackage'" [taskContextData]="taskContextData" (successReload)="closeModal()"></gu-sign-document>

          <gu-redirect *ngSwitchCase="'zac:doRedirect'" [taskContextData]="taskContextData" [target]="doRedirectTarget" (successReload)="closeModal()"></gu-redirect>

          <gu-dynamic-form *ngSwitchDefault [taskContextData]="taskContextData" (successReload)="closeModal()"></gu-dynamic-form>
        </div>
      </mat-tab>

      <!-- Assign task -->
      <mat-tab label="Toewijzen" *ngIf="ketenProcessenService.isUserAllowedToAssignTask(currentUser, taskContextData.task)">
        <div class="pt-4">
          <gu-assign-task [taskData]="taskContextData.task" [currentUser]="currentUser" (reload)="closeModal()"></gu-assign-task>
        </div>
      </mat-tab>
    </mat-tab-group>
  </ng-container>
</gu-modal>
<gu-modal id="assignTaskModal" title="Taak toewijzen" size="small">
  <gu-assign-task [taskData]="assignTaskTask"
                  [currentUser]="currentUser"
                  (successReload)="fetchProcesses()"
  >
  </gu-assign-task>
</gu-modal>
