<div class="keten-processen card">
  <h2 class="d-inline-block mr-2">Acties</h2>
  <gu-tooltip type="primary" inline="true" (click)="openBpmnVisualisation()">Bekijk BPMN model.</gu-tooltip>

  <!-- First time loading  -->
  <ng-container *ngIf="isLoading">
    <gu-loading-indicator></gu-loading-indicator>
  </ng-container>

  <!-- Loaded -->
  <ng-container *ngIf="!!data && data?.length > 0">

    <!-- Action buttons -->
    <div class="keten-processen__msg-btns-container">
      <ng-container *ngFor="let message of data[0].messages; let i = index">
        <button gu-button
                [hidden]="!isExpanded && i >= 3"
                (click)="sendMessage(message)"
                buttonStyle="action-link"
                class="mr-2 mb-3">
          {{message}}
        </button>
      </ng-container>
    </div>

    <!-- Show more buttons -->
    <button gu-button
            *ngIf="!!data && data?.length > 0"
            buttonStyle="tertiary"
            size="extrasmall"
            class="d-block mb-4"
            [icon]="isExpanded ? 'unfold_less' : 'unfold_more'"
            (click)="isExpanded = !isExpanded">
      {{isExpanded ? 'Minder acties' : 'Meer acties'}}
    </button>

    <!-- Polling  -->
    <div class="d-flex flex-column mb-4" *ngIf="isPolling">
      <mat-progress-bar class="mb-2" mode="buffer"></mat-progress-bar>
      <gu-message
        message="Er wordt gezocht naar nieuwe taken. Zodra een nieuwe taak gereed is om uitgevoerd te worden, zal deze hieronder verschijnen. Dit kan even duren."
        type="primary"
        class="mb-2"
      ></gu-message>
    </div>

    <!-- Task lists -->
    <div class="keten-processen__taken">
      <div class="row">

        <!-- Tasks for current user -->
        <div class="col-md-6 mb-4 mb-md-0">
          <h3 *ngIf="data[0]?.tasks.length > 0 || data[0]?.subProcesses.length > 0">Zelf doen</h3>
          <ng-container *ngFor="let task of allTaskData">
            <div class="taak d-flex justify-content-between"
                 *ngIf="task.assignee?.username === currentUser.username || currentUser.groups.includes(task.assignee?.name)"
            >
              <!-- Description -->
              <div class="taak__detail mr-md-2">
                <p class="m-0 p--bold">{{task.name}}</p>

                <!-- Double click shows id. -->
                <label class="label label--small mb-2" [ngClass]="(newestTaskId === task.id ? 'label--accent' : '')" (dblclick)="taskDblClick(task)">
                  <ng-container *ngIf="debugTask===task">
                    Task id: {{task.id}}
                  </ng-container>

                  <ng-container *ngIf="debugTask!==task">
                    {{task.created | niceDateFormatPipe}}
                  </ng-container>
                </label>

              </div>

              <!-- Actions -->
              <div class="d-flex flex-column justify-content-center align-items-end">
                <ng-container *ngIf="ketenProcessenService.isTaskActionableByUser(currentUser, task)">
                  <button gu-button class="mb-2" buttonStyle="primary" size="small" (click)="executeTask(task.id)">
                    Behandelen
                  </button>
                  <button gu-button
                          *ngIf="ketenProcessenService.isTaskAssigned(task) && task.assigneeType === 'group'"
                          buttonStyle="tertiary"
                          size="extrasmall"
                          [icon]="task.assigneeType === 'user' ? 'person' : 'group'"
                          class="d-inline-block mb-2"
                          (click)="ketenProcessenService.isUserAllowedToAssignTask(currentUser, task) && executeTask(task.id, 1)"
                          [disabled]="true"
                  >
                    {{task.assignee.name}}
                  </button>
                </ng-container>
              </div>
            </div>
          </ng-container>
        </div>

        <!-- Task for others -->
        <div class="col-md-6">
          <h3 *ngIf="data[0]?.tasks.length > 0 || data[0]?.subProcesses.length > 0">Wacht op anderen</h3>
          <ng-container *ngFor="let task of allTaskData">
            <div class="taak d-flex justify-content-between" *ngIf="task.assignee?.username !== currentUser.username && !currentUser.groups.includes(task.assignee?.name)">
              <!-- Description -->
              <div class="taak__detail mr-md-2">
                <p class="m-0 p--bold" *ngIf="task.name">{{task.name}}</p>

                <!-- Double click shows id. -->
                <label class="label label--small mb-2" [ngClass]="(newestTaskId === task.id ? 'label--accent' : '')" (dblclick)="taskDblClick(task)">
                  <ng-container *ngIf="debugTask===task">
                    Task id: {{task.id}}
                  </ng-container>

                  <ng-container *ngIf="debugTask!==task">
                    {{task.created | niceDateFormatPipe}}
                  </ng-container>
                </label>

                <div class="d-flex flex-column justify-content-center" *ngIf="ketenProcessenService.isTaskActionableByUser(currentUser, task)">
                  <button gu-button class="mb-2" buttonStyle="action-link" (click)="executeTask(task.id)">
                    Behandelen
                  </button>
                </div>
              </div>

              <!-- Actions -->
              <div class="d-flex flex-column justify-content-center align-items-end">
                <button gu-button
                        *ngIf="ketenProcessenService.isTaskAssigned(task)"
                        buttonStyle="tertiary"
                        size="extrasmall"
                        [icon]="task.assigneeType === 'user' ? 'person' : 'group'"
                        class="d-inline-block mb-2"
                        (click)="ketenProcessenService.isUserAllowedToAssignTask(currentUser, task) && executeTask(task.id, 1)"
                        [disabled]="!ketenProcessenService.isUserAllowedToAssignTask(currentUser, task)"
                >
                  <!-- user -->
                  <ng-container *ngIf="task.assigneeType === 'user'">
                    <ng-container *ngIf="task.assignee.firstName && task.assignee.lastName; else username" >
                      {{task.assignee.firstName}} {{task.assignee.lastName}}
                    </ng-container>
                    <ng-template #username>
                      <ng-container *ngIf="task.assignee.username">
                        {{task.assignee.username}}
                      </ng-container>
                    </ng-template>
                  </ng-container>

                  <!-- group -->
                  <ng-container *ngIf="task.assigneeType === 'group'">
                    {{task.assignee.name}}
                  </ng-container>
                </button>
              </div>
            </div>
          </ng-container>
        </div>

      </div>
    </div>
  </ng-container>

  <!-- Empty message -->
  <ng-container *ngIf="!!data && data.length === 0 && !isLoading">
    <p>Er zijn geen acties beschikbaar.</p>
  </ng-container>
</div>


<!-- BPMN modal -->
<gu-modal id="bpmnModal" [closeIcon]="true" [size]="'huge'">
  <div class="bpmn"></div>
</gu-modal>

<!-- Keten processen modal -->
<gu-modal id="ketenprocessenModal" [closeIcon]="true">

  <!-- Loading -->
  <ng-container *ngIf="isLoadingContext">
    <gu-loading-indicator></gu-loading-indicator>
  </ng-container>

  <!-- Feedback/error messages -->
  <ng-container *ngIf="contextHasError">
    <gu-message type="warn" [message]="contextErrorMessage"></gu-message>
  </ng-container>

  <!-- Loaded -->
  <ng-container *ngIf="!isLoadingContext && taskContextData" [ngSwitch]="taskContextData.form">
    <gu-tab-group alignTabs="center" [selectedIndex]="selectedTabIndex || 0">

      <!-- Execute task -->
      <gu-tab label="Uitvoeren" *ngIf="ketenProcessenService.isUserAllowedToExecuteTask(currentUser, taskContextData.task)">
        <div class="pt-4">
          <gu-config-adviseren-accorderen *ngSwitchCase="['zac:configureAdviceRequest', 'zac:configureApprovalRequest'].includes(taskContextData.form) ? taskContextData.form : !taskContextData.form"
                                          [taskContextData]="taskContextData"
                                          (successReload)="closeModal()"
          ></gu-config-adviseren-accorderen>

          <gu-document-select *ngSwitchCase="'zac:documentSelectie'" [taskContextData]="taskContextData" (successReload)="closeModal()"></gu-document-select>

          <gu-sign-document *ngSwitchCase="'zac:validSign:configurePackage'" [taskContextData]="taskContextData" (successReload)="closeModal()"></gu-sign-document>

          <gu-redirect *ngSwitchCase="'zac:doRedirect'" [taskContextData]="taskContextData" [target]="doRedirectTarget" (successReload)="closeModal()"></gu-redirect>

          <gu-dynamic-form *ngSwitchDefault [taskContextData]="taskContextData" (successReload)="closeModal()"></gu-dynamic-form>
        </div>
      </gu-tab>

      <!-- Assign task -->
      <gu-tab label="Toewijzen" *ngIf="ketenProcessenService.isUserAllowedToAssignTask(currentUser, taskContextData.task)">
        <div class="pt-4">
          <gu-assign-task [taskData]="taskContextData.task" [currentUser]="currentUser" (successReload)="closeModal()"></gu-assign-task>
        </div>
      </gu-tab>
    </gu-tab-group>
  </ng-container>

</gu-modal>
