<div class="keten-processen card">
  <!-- Loading -->
  <ng-container *ngIf="isLoading">
    <gu-loading-indicator></gu-loading-indicator>
  </ng-container>

  <!-- Loaded -->
  <ng-container *ngIf="!!data && data?.length > 0">

    <!-- Action buttons -->
    <div class="keten-processen__actie-buttons-container">
      <h3>Acties</h3>
      <ng-container *ngFor="let message of data[0].messages; let i = index">
        <button gu-button
                [hidden]="!isExpanded && i >= 3"
                (click)="sendMessage(message)"
                type="action-link"
                class="mr-2 mb-3">
          {{message}}
        </button>
      </ng-container>
      <button gu-button
              type="tertiary"
              size="extrasmall"
              class="d-block"
              [icon]="isExpanded ? 'unfold_less' : 'unfold_more'"
              (click)="isExpanded = !isExpanded">
        {{isExpanded ? 'Toon minder' : 'Meer acties'}}
      </button>
    </div>

    <!-- Feedback/error messages -->
    <div *ngIf="sendMessageHasError" class="mb-4">
      <gu-message type="warn" message="{{sendMessageErrorMessage}}"></gu-message>
    </div>

    <!-- Task lists -->
    <div class="keten-processen__taken">
      <div class="row">

        <!-- Tasks -->
        <div class="col-md-6 mb-4 mb-md-0">
          <h3 *ngIf="data[0]?.tasks.length > 0">Zelf doen</h3>
          <ng-container *ngFor="let task of allTaskData">
            <div class="taak d-flex justify-content-between" *ngIf="task.assignee?.username === currentUser.username">
              <!-- Description -->
              <div class="taak__detail mr-md-2">
                <label class="label label--date">{{task.created | date:'fullDate'}}</label>
                <p class="p--marginsmall p--bold">{{task.name}}</p>

                <gu-chip *ngIf="ketenProcessenService.isTaskAssigned(task)"
                         [color]="ketenProcessenService.isTaskAssignedToUser(currentUser, task) ? 'primary' : 'tertiary'"
                         [icon]="ketenProcessenService.isUserAllowedToAssignTask(currentUser, task) ? 'edit' : null"
                         (click)="ketenProcessenService.isUserAllowedToAssignTask(currentUser, task) && executeTask(task.id, 1)"
                         class="d-inline-block mb-2"
                         [class.chip--clickable]="ketenProcessenService.isUserAllowedToAssignTask(currentUser, task)"
                >

                  <ng-container *ngIf="task.assignee.firstName && task.assignee.lastName; else username" >
                    {{task.assignee.firstName}} {{task.assignee.lastName}}
                  </ng-container>

                  <ng-template #username>
                    {{task.assignee.username}}
                  </ng-template>
                </gu-chip>
              </div>

              <!-- Actions -->
              <div class="d-flex flex-column justify-content-center">
                <ng-container *ngIf="ketenProcessenService.isTaskActionableByUser(currentUser, task)">
                  <button gu-button class="mb-2" type="action-link" (click)="executeTask(task.id)">
                    Behandelen
                  </button>
                </ng-container>
              </div>
            </div>
          </ng-container>
        </div>

        <!-- Sub processes -->
        <div class="col-md-6">
          <h3 *ngIf="data[0]?.subProcesses.length > 0">Wacht op anderen</h3>
          <ng-container *ngFor="let task of allTaskData">
            <div class="taak d-flex justify-content-between" *ngIf="task.assignee?.username !== currentUser.username">
              <!-- Description -->
              <div class="taak__detail mr-md-2">
                <label class="label label--date">{{task.created | date:'fullDate'}}</label>
                <p class="p--marginsmall p--bold" *ngIf="task.name">{{task.name}}</p>

                <gu-chip *ngIf="ketenProcessenService.isTaskAssigned(task)"
                         [color]="ketenProcessenService.isTaskAssignedToUser(currentUser, task) ? 'primary' : 'tertiary'"
                         [icon]="ketenProcessenService.isUserAllowedToAssignTask(currentUser, task) ? 'edit' : null"
                         (click)="ketenProcessenService.isUserAllowedToAssignTask(currentUser, task) && executeTask(task.id, 1)"
                         class="d-inline-block mb-2"
                         [class.chip--clickable]="ketenProcessenService.isUserAllowedToAssignTask(currentUser, task)"
                >

                  <ng-container *ngIf="task.assignee.firstName && task.assignee.lastName; else username" >
                    {{task.assignee.firstName}} {{task.assignee.lastName}}
                  </ng-container>
                  <ng-template #username>
                    {{task.assignee.username}}
                  </ng-template>
                </gu-chip>
              </div>

                <!-- Actions -->
                <div class="d-flex flex-column justify-content-center">
                  <ng-container *ngIf="ketenProcessenService.isTaskActionableByUser(currentUser, task)">
                    <button gu-button class="mb-2" type="action-link" (click)="executeTask(task.id)">
                      Behandelen
                    </button>
                  </ng-container>
                </div>
            </div>
          </ng-container>
        </div>

      </div>
    </div>
  </ng-container>

  <!-- Empty message -->
  <ng-container *ngIf="!!data && data.length === 0 && !isLoading">
    <p>Er zijn geen acties beschikbaar.</p>
  </ng-container>
</div>


<!-- Modal -->
<gu-modal id="ketenprocessenModal" [closeIcon]="true">

  <!-- Loading -->
  <ng-container *ngIf="isLoadingContext">
    <gu-loading-indicator></gu-loading-indicator>
  </ng-container>

  <!-- Feedback/error messages -->
  <ng-container *ngIf="contextHasError">
    <gu-message type="warn" [message]="contextErrorMessage"></gu-message>
  </ng-container>

  <!-- Loaded -->
  <ng-container *ngIf="!isLoadingContext && taskContextData" [ngSwitch]="taskContextData.form">
    <gu-tab-group alignTabs="center" [selectedIndex]="selectedTabIndex || 0">

      <!-- Execute task -->
      <gu-tab label="Uitvoeren" *ngIf="ketenProcessenService.isUserAllowedToExecuteTask(currentUser, taskContextData.task)">
        <div class="pt-4">
          <gu-config-adviseren-accorderen *ngSwitchCase="['zac:configureAdviceRequest', 'zac:configureApprovalRequest'].includes(taskContextData.form) ? taskContextData.form : !taskContextData.form"
                                          [taskContextData]="taskContextData"
                                          (successReload)="fetchProcesses()"
          ></gu-config-adviseren-accorderen>

          <gu-document-select *ngSwitchCase="'zac:documentSelectie'" [taskContextData]="taskContextData" (successReload)="closeModal()"></gu-document-select>

          <gu-sign-document *ngSwitchCase="'zac:validSign:configurePackage'" [taskContextData]="taskContextData" (successReload)="closeModal()"></gu-sign-document>

          <gu-redirect *ngSwitchCase="'zac:doRedirect'" [taskContextData]="taskContextData" [target]="doRedirectTarget" (successReload)="closeModal()"></gu-redirect>

          <gu-dynamic-form *ngSwitchDefault [taskContextData]="taskContextData" (successReload)="closeModal()"></gu-dynamic-form>
        </div>
      </gu-tab>

      <!-- Assign task -->
      <gu-tab label="Toewijzen" *ngIf="ketenProcessenService.isUserAllowedToAssignTask(currentUser, taskContextData.task)">
        <div class="pt-4">
          <gu-assign-task [taskData]="taskContextData.task" [currentUser]="currentUser" (successReload)="closeModal()"></gu-assign-task>
        </div>
      </gu-tab>
    </gu-tab-group>
  </ng-container>
</gu-modal>
