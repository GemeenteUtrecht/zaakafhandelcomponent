{% extends "master.html" %}
{% load i18n sniplates rules %}

{% block body-class %}zaak-detail-page{% endblock %}


{% block nav-main-id %}
<article class="object-id">
    <h1 class="object-id__identifier" title="Identificatie">
        {{ zaak.identificatie }}
    </h1>
    <p class="object-id__secondary" title="Bronorganisatie">
        {{ zaak.bronorganisatie }}
    </p>
    <p class="object-id__secondary" title="Startdatum">
        {{ zaak.startdatum|date }}
    </p>

    <p class="object-id__secondary" title="Vertrouwelijkheidaanduiding">
        <strong>{{ zaak.get_vertrouwelijkheidaanduiding_display }}</strong>
    </p>
</article>
{% endblock %}


{% block content %}

{% has_perm 'zaakproces:send-bpmn-message' user zaak as can_send_bpmn_messages %}
{% has_perm 'zaakproces:usertasks-uitvoeren' user zaak as can_do_usertasks %}
{% has_perm 'zaak:afhandelen' user zaak as can_do_zaakafhandeling %}
{% has_perm 'zaken:create-status' user zaak as can_create_status %}

{% load_widgets kv='sniplates/key-value.html' %}

<header class="zaak-detail-page__header">
    {% include "core/includes/zaaktype_header.html" %}

    <nav class="page-controls page-controls--align-right">

        {% if not zaak.einddatum %}

            {% if can_do_zaakafhandeling %}
            <a href="{% url 'core:zaak-afhandeling' bronorganisatie=zaak.bronorganisatie identificatie=zaak.identificatie %}"
                class="link link--plain link--disabled"
                data-msg="Zaakafhandeling moet via de taken verlopen.">
                <button type="button" class="btn btn--control btn btn--control-focus">
                    Handel zaak af
                </button>
            </a>
            {% endif %}

            {% if can_create_status %}
                <a href="#" class="btn btn--control link link--plain link--disabled">Zet nieuwe status</a>
            {% endif %}
        {% endif %}
    </nav>
</header>

<article class="zaak-detail">

    {% if zaak.resultaat %}
    <section class="zaak-detail__resultaat" title="{{ resultaat.toelichting }}">
        <i class="material-icons" title="uitkomst">gavel</i>
        <strong>{{ resultaat.resultaattype.omschrijving }}</strong>
    </section>
    {% endif %}

    <section class="zaak-detail__panel content-panel">
        <div class="section-title">Zaakinformatie</div>

        <p class="content-panel__content {% if not zaak.omschrijving %}content-panel__content--blurred{% endif %}">
            {{ zaak.omschrijving|default:"(geen omschrijving)" }}
        </p>

        <p class="content-panel__content {% if not zaak.toelichting %}content-panel__content--blurred{% endif %}">
            {{ zaak.toelichting|linebreaksbr|default:"(geen toelichting)" }}
        </p>

        <div class="section-title">Eigenschappen</div>
        <div>
            {% for eigenschap in eigenschappen %}
                {% nested_widget 'kv:key-value' label=eigenschap.naam %}
                    {{ eigenschap.get_waarde }}
                {% endnested %}
            {% endfor %}
            <br>
        </div>

        <div class="section-title">Betrokkenen</div>
                <div>
            {% for rol in rollen %}
                {% nested_widget 'kv:key-value' label=rol.get_betrokkene_type_display %}
                    {{ rol.get_omschrijving_generiek_display }}
                {% endnested %}
            {% endfor %}
            <br>
        </div>
    </section>

    <section class="zaak-detail__panel content-panel">
        <div class="section-title">Status</div>

        {% nested_widget 'kv:key-value' label=_("Uiterlijke einddatum") %}
            {{ zaak.deadline|date|default:_("-") }}
        {% endnested %}

        {% if not zaak.einddatum %}
            <div class="zaak-detail__deadline-progress">
                {% include "includes/progress.html" with progress=zaak.deadline_progress %}
            </div>
        {% else %}
            <p class="content-panel__content content-panel__content--highlighted">
                Afgehandeld op {{ zaak.einddatum|date }}
            </p>
        {% endif %}

        Geschiedenis

        <ul class="timeline zaak-detail__statuses">

            {# Legenda #}
            <li class="timeline__item timeline__item--legenda">
                <div class="timeline__item-nr"></div>

                <div class="timeline__item-content zaak-detail__status-details">
                    <div class="zaak-detail__status">
                        <strong>Status</strong>
                    </div>
                    <div class="zaak-detail__status-toelichting">
                        <strong>Toelichting</strong>
                    </div>
                </div>
            </li>

            {# Status history #}
            {% for status in statussen %}
                <li class="timeline__item">
                    <div class="timeline__item-nr" title="volgnummer">
                        {{ status.statustype.volgnummer }}
                    </div>

                    <div class="timeline__item-content zaak-detail__status-details">

                        <div class="zaak-detail__status">
                            <strong>{{ status.statustype.omschrijving }}</strong>
                            <time class="timeline__item-timestamp" datetime="{{ status.datum_status_gezet.isoformat }}" title="{{ status.datum_status_gezet }}">
                                {{ status.datum_status_gezet|timesince }} geleden
                            </time>
                        </div>

                        <div class="zaak-detail__status-toelichting">
                            {{ status.statustoelichting|linebreaksbr|default:'-' }}
                        </div>

                    </div>
                </li>
            {% endfor %}

        </ul>

    </section>

    <section class="zaak-detail__panel content-panel">
        {% if pmn_messages or can_do_usertasks %}
            <div class="section-title">Proces</div>

            {% if can_send_bpmn_messages %}
            <div class="fetch-messages" data-for-zaak="{{ zaak.url }}" data-url="{% url 'core:fetch-messages' %}">
                {# include template is in core/includes/messages.html #}
                <span class="loader"></span>
            </div>
            {% endif %}

            {% if can_do_usertasks %}
            <div class="fetch-tasks" data-for-zaak="{{ zaak.url }}" data-url="{% url 'core:fetch-tasks' %}">
                {# include template is in core/includes/tasks.html #}
                <span class="loader"></span>
            </div>
            {% endif %}
        {% else %}
            <p class="permission-check permission-check--failed">
                Je hebt onvoldoende rechten op processturing.
            </p>
        {% endif %}
    </section>

    <section class="zaak-detail__panel content-panel">
        <div class="section-title">Geometrie</div>
        TODO
    </section>

    {% if related_zaken %}
    <section class="zaak-detail__panel zaak-detail__panel--full content-panel">
        <div class="section-title">Gerelateerde zaken ({{ related_zaken|length }})</div>

        <table class="table">
            <thead>
                <tr>
                    <th class="table__header">Identificatie</th>
                    <th class="table__header">Zaaktype</th>
                    <th class="table__header">Aard</th>
                    <th class="table__header">Status</th>
                    <th class="table__header">Resultaat</th>
                    <th class="table__header"># Adviezen</th>
                </tr>
            </thead>

            <tbody>
                {% for relatie_aard, zaak in related_zaken %}
                    <tr>
                        <th class="table__id-column">
                            <a
                                href="{% url 'core:zaak-detail' bronorganisatie=zaak.bronorganisatie identificatie=zaak.identificatie %}"
                                target="_blank" rel="nofollow noopener">
                                {{ zaak.identificatie }}
                            </a>
                        </th>
                        <td> {{ zaak.zaaktype.omschrijving }}</td>
                        <td> {{ relatie_aard }} </td>
                        <td> {{ zaak.status.statustype.omschrijving }} </td>
                        <td> {{ zaak.resultaat.resultaattype.omschrijving }} </td>
                        <td> {{ zaak.n_advices|default:"-" }} </td>
                    </tr>
                {% endfor %}
                {% for io_url in documenten_gone %}
                    <tr>
                        <td colspan="5">
                            Document <code>{{ io_url }}</code> bestaat niet (meer).
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </section>
    {% endif %}

    <section class="zaak-detail__panel zaak-detail__panel--full content-panel">
        <div class="section-title">Gerelateerde objecten</div>

        <div class="fetch-zaakobjecten" data-for-zaak="{{ zaak.url }}" data-url="{% url 'core:fetch-zaakobjecten' %}">
            {# include template is in core/includes/zaakobjecten.html #}
            <span class="loader"></span>
        </div>
    </section>

    {% if documenten %}
    <section class="zaak-detail__panel zaak-detail__panel--full content-panel">
        <div class="section-title">Documenten</div>

        <table class="table">
            <thead>
                <tr>
                    <th class="table__header">Type</th>
                    <th class="table__header">Titel</th>
                    <th class="table__header">Vertrouwelijkheidaanduiding</th>
                    <th class="table__header">Bestandsgrootte</th>
                    <th class="table__header">Download</th>
                </tr>
            </thead>

            <tbody>
                {% for document in documenten %}
                    <tr>
                        <td> {{ document.informatieobjecttype.omschrijving }} </td>
                        <td> {{ document.titel }}</td>
                        <td> {{ document.get_vertrouwelijkheidaanduiding_display }} </td>
                        <td> {{ document.bestandsomvang|filesizeformat }} </td>
                        <th class="table__id-column">
                            {% include "core/includes/document_link.html" with document=document only %}
                        </th>
                    </tr>
                {% endfor %}
                {% for io_url in documenten_gone %}
                    <tr>
                        <td colspan="5">
                            Document <code>{{ io_url }}</code> bestaat niet (meer).
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>

    </section>
    {% endif %}

    {% if advices %}
    <section class="zaak-detail__panel zaak-detail__panel--full content-panel">
        <div class="section-title">Adviezen</div>
        {% include "advices/includes/advice_table.html" with advices=advices only %}
    </section>
    {% endif %}

</article>

{% endblock content %}
